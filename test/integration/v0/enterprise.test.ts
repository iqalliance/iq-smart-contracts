import {Signer} from '@ethereum-waffle/provider/node_modules/ethers';
import {Contract} from '@ethersproject/contracts';
import {SignerWithAddress} from '@nomiclabs/hardhat-ethers/dist/src/signers';
import {expect} from 'chai';
import hre, {ethers} from 'hardhat';
import {
  BorrowToken,
  BorrowToken__factory,
  InterestToken,
  InterestToken__factory,
  PowerToken,
  PowerToken__factory,
} from '../../../typechain';
import {impersonate, resetFork} from '../../utils';
import {PARSIQ_ENTERPRISE_ADDRESS} from '../addresses';

// prettier-ignore
const ENTERPRISE_ABI = [{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"baseUri","type":"string"}],"name":"BaseUriChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"pole","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"slope","type":"uint256"}],"name":"BondingChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"powerToken","type":"address"},{"indexed":true,"internalType":"uint256","name":"borrowTokenId","type":"uint256"}],"name":"Borrowed","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint32","name":"period","type":"uint32"}],"name":"BorrowerLoanReturnGracePeriodChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"converter","type":"address"}],"name":"ConverterChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"collector","type":"address"}],"name":"EnterpriseCollectorChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint32","name":"period","type":"uint32"}],"name":"EnterpriseLoanCollectGracePeriodChanged","type":"event"},{"anonymous":false,"inputs":[],"name":"EnterpriseShutdown","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"vault","type":"address"}],"name":"EnterpriseVaultChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"fixedReserve","type":"uint256"}],"name":"FixedReserveChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint16","name":"percent","type":"uint16"}],"name":"GcFeePercentChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint32","name":"period","type":"uint32"}],"name":"InterestGapHalvingPeriodChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"interestTokenId","type":"uint256"},{"indexed":true,"internalType":"enum Enterprise.LiquidityChangeType","name":"changeType","type":"uint8"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"LiquidityChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"borrowTokenId","type":"uint256"}],"name":"LoanReturned","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"paymentToken","type":"address"},{"indexed":false,"internalType":"bool","name":"enabled","type":"bool"}],"name":"PaymentTokenChange","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"powerToken","type":"address"}],"name":"ServiceRegistered","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint112","name":"streamingReserve","type":"uint112"},{"indexed":false,"internalType":"uint112","name":"streamingReserveTarget","type":"uint112"}],"name":"StreamingReserveChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"totalShares","type":"uint256"}],"name":"TotalSharesChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"fixedReserve","type":"uint256"}],"name":"UsedReserveChanged","type":"event"},{"inputs":[{"internalType":"uint256","name":"liquidityAmount","type":"uint256"}],"name":"addLiquidity","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"contract PowerToken","name":"powerToken","type":"address"},{"internalType":"contract IERC20","name":"paymentToken","type":"address"},{"internalType":"uint112","name":"amount","type":"uint112"},{"internalType":"uint32","name":"duration","type":"uint32"},{"internalType":"uint256","name":"maxPayment","type":"uint256"}],"name":"borrow","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"interestTokenId","type":"uint256"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"decreaseLiquidity","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"disablePaymentToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"enablePaymentToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"contract PowerToken","name":"powerToken","type":"address"},{"internalType":"contract IERC20","name":"paymentToken","type":"address"},{"internalType":"uint112","name":"amount","type":"uint112"},{"internalType":"uint32","name":"duration","type":"uint32"}],"name":"estimateLoan","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"interestTokenId","type":"uint256"}],"name":"getAccruedInterest","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getAvailableReserve","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getBaseUri","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getBondingCurve","outputs":[{"internalType":"uint256","name":"pole","type":"uint256"},{"internalType":"uint256","name":"slope","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getBorrowToken","outputs":[{"internalType":"contract IBorrowToken","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getBorrowerLoanReturnGracePeriod","outputs":[{"internalType":"uint32","name":"","type":"uint32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getConverter","outputs":[{"internalType":"contract IConverter","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getEnterpriseCollector","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getEnterpriseLoanCollectGracePeriod","outputs":[{"internalType":"uint32","name":"","type":"uint32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getEnterpriseVault","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getGCFeePercent","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getInfo","outputs":[{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"baseUri","type":"string"},{"internalType":"uint256","name":"totalShares","type":"uint256"},{"internalType":"uint32","name":"interestGapHalvingPeriod","type":"uint32"},{"internalType":"uint32","name":"borrowerLoanReturnGracePeriod","type":"uint32"},{"internalType":"uint32","name":"enterpriseLoanCollectGracePeriod","type":"uint32"},{"internalType":"uint16","name":"gcFeePercent","type":"uint16"},{"internalType":"uint256","name":"fixedReserve","type":"uint256"},{"internalType":"uint256","name":"usedReserve","type":"uint256"},{"internalType":"uint112","name":"streamingReserve","type":"uint112"},{"internalType":"uint112","name":"streamingReserveTarget","type":"uint112"},{"internalType":"uint32","name":"streamingReserveUpdated","type":"uint32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getInterestGapHalvingPeriod","outputs":[{"internalType":"uint32","name":"","type":"uint32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getInterestToken","outputs":[{"internalType":"contract IInterestToken","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"interestTokenId","type":"uint256"}],"name":"getLiquidityInfo","outputs":[{"components":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"shares","type":"uint256"},{"internalType":"uint256","name":"block","type":"uint256"}],"internalType":"struct EnterpriseStorage.LiquidityInfo","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getLiquidityToken","outputs":[{"internalType":"contract IERC20Metadata","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"borrowTokenId","type":"uint256"}],"name":"getLoanInfo","outputs":[{"components":[{"internalType":"uint112","name":"amount","type":"uint112"},{"internalType":"uint16","name":"powerTokenIndex","type":"uint16"},{"internalType":"uint32","name":"borrowingTime","type":"uint32"},{"internalType":"uint32","name":"maturityTime","type":"uint32"},{"internalType":"uint32","name":"borrowerReturnGraceTime","type":"uint32"},{"internalType":"uint32","name":"enterpriseCollectGraceTime","type":"uint32"},{"internalType":"uint112","name":"gcFee","type":"uint112"},{"internalType":"uint16","name":"gcFeeTokenIndex","type":"uint16"}],"internalType":"struct EnterpriseStorage.LoanInfo","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getPowerTokens","outputs":[{"internalType":"contract PowerToken[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getProxyAdmin","outputs":[{"internalType":"contract ProxyAdmin","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getReserve","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getUsedReserve","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"interestTokenId","type":"uint256"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"increaseLiquidity","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"enterpriseName","type":"string"},{"internalType":"string","name":"baseUri","type":"string"},{"internalType":"uint16","name":"gcFeePercent","type":"uint16"},{"internalType":"contract IConverter","name":"converter","type":"address"},{"internalType":"contract ProxyAdmin","name":"proxyAdmin","type":"address"},{"internalType":"address","name":"owner","type":"address"}],"name":"initialize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"initialOwner","type":"address"}],"name":"initialize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"contract IERC20Metadata","name":"liquidityToken","type":"address"},{"internalType":"contract IInterestToken","name":"interestToken","type":"address"},{"internalType":"contract IBorrowToken","name":"borrowToken","type":"address"}],"name":"initializeTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"contract PowerToken","name":"powerToken","type":"address"}],"name":"isRegisteredPowerToken","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"contract IERC20","name":"token","type":"address"}],"name":"isSupportedPaymentToken","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"borrowTokenId","type":"uint256"}],"name":"loanTransfer","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"paymentToken","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"contract IERC20","name":"token","type":"address"}],"name":"paymentTokenIndex","outputs":[{"internalType":"int16","name":"","type":"int16"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"borrowTokenId","type":"uint256"},{"internalType":"contract IERC20","name":"paymentToken","type":"address"},{"internalType":"uint32","name":"duration","type":"uint32"},{"internalType":"uint256","name":"maxPayment","type":"uint256"}],"name":"reborrow","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"serviceName","type":"string"},{"internalType":"string","name":"symbol","type":"string"},{"internalType":"uint32","name":"gapHalvingPeriod","type":"uint32"},{"internalType":"uint112","name":"baseRate","type":"uint112"},{"internalType":"contract IERC20Metadata","name":"baseToken","type":"address"},{"internalType":"uint16","name":"serviceFeePercent","type":"uint16"},{"internalType":"uint32","name":"minLoanDuration","type":"uint32"},{"internalType":"uint32","name":"maxLoanDuration","type":"uint32"},{"internalType":"uint96","name":"minGCFee","type":"uint96"},{"internalType":"bool","name":"allowsPerpetualTokensForever","type":"bool"}],"name":"registerService","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"interestTokenId","type":"uint256"}],"name":"removeLiquidity","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"borrowTokenId","type":"uint256"}],"name":"returnLoan","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"baseUri","type":"string"}],"name":"setBaseUri","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"pole","type":"uint256"},{"internalType":"uint256","name":"slope","type":"uint256"}],"name":"setBondingCurve","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint32","name":"newPeriod","type":"uint32"}],"name":"setBorrowerLoanReturnGracePeriod","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"contract IConverter","name":"newConverter","type":"address"}],"name":"setConverter","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newCollector","type":"address"}],"name":"setEnterpriseCollector","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint32","name":"newPeriod","type":"uint32"}],"name":"setEnterpriseLoanCollectGracePeriod","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newVault","type":"address"}],"name":"setEnterpriseVault","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint16","name":"newGcFeePercent","type":"uint16"}],"name":"setGcFeePercent","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint32","name":"interestGapHalvingPeriod","type":"uint32"}],"name":"setInterestGapHalvingPeriod","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"shutdownEnterpriseForever","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"implementation","type":"address"}],"name":"upgradeBorrowToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"implementation","type":"address"}],"name":"upgradeEnterprise","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"implementation","type":"address"}],"name":"upgradeInterestToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"contract PowerToken","name":"powerToken","type":"address"},{"internalType":"address","name":"implementation","type":"address"}],"name":"upgradePowerToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"interestTokenId","type":"uint256"}],"name":"withdrawInterest","outputs":[],"stateMutability":"nonpayable","type":"function"}]
// prettier-ignore
const BORROW_TOKEN_ABI = [{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"address","name":"burner","type":"address"}],"name":"burn","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getEnterprise","outputs":[{"internalType":"contract Enterprise","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getNextTokenId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"symbol","type":"string"},{"internalType":"contract Enterprise","name":"enterprise","type":"address"}],"name":"initialize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"name_","type":"string"},{"internalType":"string","name":"symbol_","type":"string"}],"name":"initialize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"contract Enterprise","name":"enterprise","type":"address"}],"name":"initialize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"}],"name":"mint","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"bytes","name":"_data","type":"bytes"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"tokenByIndex","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"uint256","name":"index","type":"uint256"}],"name":"tokenOfOwnerByIndex","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"}]
// prettier-ignore
const INTEREST_TOKEN_ABI = [{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"burn","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getEnterprise","outputs":[{"internalType":"contract Enterprise","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getNextTokenId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"name_","type":"string"},{"internalType":"string","name":"symbol_","type":"string"},{"internalType":"contract Enterprise","name":"enterprise","type":"address"}],"name":"initialize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"name_","type":"string"},{"internalType":"string","name":"symbol_","type":"string"}],"name":"initialize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"contract Enterprise","name":"enterprise","type":"address"}],"name":"initialize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"}],"name":"mint","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"bytes","name":"_data","type":"bytes"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"tokenByIndex","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"uint256","name":"index","type":"uint256"}],"name":"tokenOfOwnerByIndex","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"}]
// prettier-ignore
const POWER_TOKEN_ABI = [{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint112","name":"baseRate","type":"uint112"},{"indexed":false,"internalType":"address","name":"baseToken","type":"address"},{"indexed":false,"internalType":"uint96","name":"minGCFee","type":"uint96"}],"name":"BaseRateChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint32","name":"minDuration","type":"uint32"},{"indexed":false,"internalType":"uint32","name":"maxDuration","type":"uint32"}],"name":"LoanDurationLimitsChanged","type":"event"},{"anonymous":false,"inputs":[],"name":"PerpetualAllowed","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint16","name":"percent","type":"uint16"}],"name":"ServiceFeePercentChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[],"name":"allowPerpetualForever","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"availableBalanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"burnFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"subtractedValue","type":"uint256"}],"name":"decreaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"who","type":"address"},{"internalType":"uint32","name":"timestamp","type":"uint32"}],"name":"energyAt","outputs":[{"internalType":"uint112","name":"","type":"uint112"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"contract IERC20","name":"paymentToken","type":"address"},{"internalType":"uint112","name":"amount","type":"uint112"},{"internalType":"uint32","name":"duration","type":"uint32"}],"name":"estimateLoan","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"contract IERC20","name":"paymentToken","type":"address"},{"internalType":"uint112","name":"amount","type":"uint112"},{"internalType":"uint32","name":"duration","type":"uint32"}],"name":"estimateLoanDetailed","outputs":[{"internalType":"uint112","name":"interest","type":"uint112"},{"internalType":"uint112","name":"serviceFee","type":"uint112"},{"internalType":"uint112","name":"gcFee","type":"uint112"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"forceTransfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getAllowsPerpetual","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getBaseRate","outputs":[{"internalType":"uint112","name":"","type":"uint112"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getBaseToken","outputs":[{"internalType":"contract IERC20Metadata","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getEnterprise","outputs":[{"internalType":"contract Enterprise","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getGapHalvingPeriod","outputs":[{"internalType":"uint32","name":"","type":"uint32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getIndex","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getInfo","outputs":[{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"symbol","type":"string"},{"internalType":"uint112","name":"baseRate","type":"uint112"},{"internalType":"uint96","name":"minGCFee","type":"uint96"},{"internalType":"uint32","name":"gapHalvingPeriod","type":"uint32"},{"internalType":"uint16","name":"index","type":"uint16"},{"internalType":"contract IERC20Metadata","name":"baseToken","type":"address"},{"internalType":"uint32","name":"minLoanDuration","type":"uint32"},{"internalType":"uint32","name":"maxLoanDuration","type":"uint32"},{"internalType":"uint16","name":"serviceFeePercent","type":"uint16"},{"internalType":"bool","name":"allowsPerpetual","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMaxLoanDuration","outputs":[{"internalType":"uint32","name":"","type":"uint32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMinGCFee","outputs":[{"internalType":"uint96","name":"","type":"uint96"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMinLoanDuration","outputs":[{"internalType":"uint32","name":"","type":"uint32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getServiceFeePercent","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"getState","outputs":[{"components":[{"internalType":"uint112","name":"lockedBalance","type":"uint112"},{"internalType":"uint112","name":"energy","type":"uint112"},{"internalType":"uint32","name":"timestamp","type":"uint32"}],"internalType":"struct PowerTokenStorage.State","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"addedValue","type":"uint256"}],"name":"increaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"name_","type":"string"},{"internalType":"string","name":"symbol_","type":"string"},{"internalType":"uint8","name":"decimals_","type":"uint8"}],"name":"initialize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"contract Enterprise","name":"enterprise","type":"address"},{"internalType":"uint112","name":"baseRate","type":"uint112"},{"internalType":"uint96","name":"minGCFee","type":"uint96"},{"internalType":"uint32","name":"gapHalvingPeriod","type":"uint32"},{"internalType":"uint16","name":"index","type":"uint16"},{"internalType":"contract IERC20Metadata","name":"baseToken","type":"address"},{"internalType":"uint32","name":"minLoanDuration","type":"uint32"},{"internalType":"uint32","name":"maxLoanDuration","type":"uint32"},{"internalType":"uint16","name":"serviceFeePercent","type":"uint16"},{"internalType":"bool","name":"allowsPerpetual","type":"bool"}],"name":"initialize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"contract Enterprise","name":"enterprise","type":"address"}],"name":"initialize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint32","name":"duration","type":"uint32"}],"name":"isAllowedLoanDuration","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"mint","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"borrowTokenId","type":"uint256"}],"name":"notifyNewLoan","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint112","name":"baseRate","type":"uint112"},{"internalType":"contract IERC20Metadata","name":"baseToken","type":"address"},{"internalType":"uint96","name":"minGCFee","type":"uint96"}],"name":"setBaseRate","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint32","name":"minLoanDuration","type":"uint32"},{"internalType":"uint32","name":"maxLoanDuration","type":"uint32"}],"name":"setLoanDurationLimits","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint16","name":"newServiceFeePercent","type":"uint16"}],"name":"setServiceFeePercent","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"unwrap","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"wrap","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"wrapTo","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}]

describe('Integration', () => {
  let user: SignerWithAddress;
  let enterprise: Contract;
  let admin: SignerWithAddress;

  beforeEach(async () => {
    await resetFork(hre, 11700000);

    [, user] = await ethers.getSigners();
    enterprise = new Contract(PARSIQ_ENTERPRISE_ADDRESS, ENTERPRISE_ABI, user);

    const [owner] = await enterprise.functions.owner();
    await impersonate(hre, owner);
    admin = await ethers.getSigner(owner);
  });

  describe('BorrowToken', () => {
    let borrowToken: Contract;
    let newBorrowToken: BorrowToken;

    beforeEach(async () => {
      const borrowTokenAddress = await enterprise.functions.getBorrowToken();

      borrowToken = new Contract(borrowTokenAddress[0], BORROW_TOKEN_ABI, user);

      newBorrowToken = await new BorrowToken__factory(user).deploy();
    });

    it('should successfully upgrade', async () => {
      const [tokenId] = await borrowToken.functions.getNextTokenId();
      const [enterpriseAddress] = await borrowToken.functions.getEnterprise();
      const [zeroTokenId] = await borrowToken.functions.tokenByIndex(0);
      const [totalSupply] = await borrowToken.functions.totalSupply();

      await enterprise
        .connect(admin)
        .upgradeBorrowToken(newBorrowToken.address);

      const upgraded = BorrowToken__factory.connect(borrowToken.address, user);

      expect(tokenId).is.above(0);
      expect(await upgraded.totalSupply()).to.deep.eq(totalSupply);
      expect(await upgraded.getNextTokenId()).to.deep.eq(tokenId);
      expect(await upgraded.getEnterprise()).to.deep.eq(enterpriseAddress);
      expect(await upgraded.tokenByIndex(0)).to.deep.eq(zeroTokenId);
    });
  });

  describe('Interest Token', () => {
    let interestToken: Contract;
    let newInterestToken: InterestToken;

    beforeEach(async () => {
      const [interestTokenAddress] =
        await enterprise.functions.getInterestToken();

      interestToken = new Contract(
        interestTokenAddress,
        INTEREST_TOKEN_ABI,
        user
      );

      newInterestToken = await new InterestToken__factory(user).deploy();
    });

    it('should successfully upgrade', async () => {
      const [tokenId] = await interestToken.functions.getNextTokenId();
      const [enterpriseAddress] = await interestToken.functions.getEnterprise();
      const [zeroTokenId] = await interestToken.functions.tokenByIndex(0);
      const [totalSupply] = await interestToken.functions.totalSupply();

      await enterprise
        .connect(admin)
        .upgradeInterestToken(newInterestToken.address);

      const upgraded = InterestToken__factory.connect(
        interestToken.address,
        user
      );
      expect(tokenId).is.above(0);
      expect(await upgraded.totalSupply()).to.deep.eq(totalSupply);
      expect(await upgraded.getNextTokenId()).to.deep.eq(tokenId);
      expect(await upgraded.getEnterprise()).to.deep.eq(enterpriseAddress);
      expect(await upgraded.tokenByIndex(0)).to.deep.eq(zeroTokenId);
    });
  });

  describe('Power Token', () => {
    const referenceAddress = '0x979c2f8df5d6df2bcf2a6771117f7a62a7462621';
    let powerTokens: Contract[];
    let newPowerToken: PowerToken;
    let allows: boolean[];
    let balances: any;
    let totalSupply: any;
    let upgraded: PowerToken[];

    beforeEach(async () => {
      const [tokens] = await enterprise.functions.getPowerTokens();

      powerTokens = tokens.map(
        (x: string) => new Contract(x, POWER_TOKEN_ABI, user)
      );

      newPowerToken = await new PowerToken__factory(user).deploy();
      allows = await Promise.all(
        powerTokens.map((x) => x.functions.getAllowsPerpetual())
      ).then((x) => x.map((y) => y[0]));
      balances = await Promise.all(
        powerTokens.map((x) => x.functions.balanceOf(referenceAddress))
      ).then((x) => x.map((y) => y[0]));
      totalSupply = await Promise.all(
        powerTokens.map((x) => x.functions.totalSupply())
      ).then((x) => x.map((y) => y[0]));

      await Promise.all(
        powerTokens.map((x) =>
          enterprise
            .connect(admin)
            .upgradePowerToken(x.address, newPowerToken.address)
        )
      );

      upgraded = powerTokens.map((x) =>
        PowerToken__factory.connect(x.address, user)
      );
    });

    it('should successfully upgrade', async () => {
      expect(
        await Promise.all(upgraded.map((x) => x.isWrappingEnabled()))
      ).to.deep.eq(allows);
      expect(
        await Promise.all(upgraded.map((x) => x.balanceOf(referenceAddress)))
      ).to.deep.eq(balances);
      expect(
        await Promise.all(upgraded.map((x) => x.totalSupply()))
      ).to.deep.eq(totalSupply);
      expect(
        await Promise.all(upgraded.map((x) => x.isTransfersEnabled()))
      ).to.deep.eq([false, false, false, false]);
      expect(
        await Promise.all(upgraded.map((x) => x.getEnterprise()))
      ).to.deep.eq([
        enterprise.address,
        enterprise.address,
        enterprise.address,
        enterprise.address,
      ]);
    });

    it('should keep the same after transfers are enabled', async () => {
      await Promise.all(
        upgraded.map((x) => x.connect(admin).enableTransfersForever())
      );

      expect(
        await Promise.all(upgraded.map((x) => x.isWrappingEnabled()))
      ).to.deep.eq(allows);
      expect(
        await Promise.all(upgraded.map((x) => x.balanceOf(referenceAddress)))
      ).to.deep.eq(balances);
      expect(
        await Promise.all(upgraded.map((x) => x.totalSupply()))
      ).to.deep.eq(totalSupply);
      expect(
        await Promise.all(upgraded.map((x) => x.isTransfersEnabled()))
      ).to.deep.eq([true, true, true, true]);
      expect(
        await Promise.all(upgraded.map((x) => x.getEnterprise()))
      ).to.deep.eq([
        enterprise.address,
        enterprise.address,
        enterprise.address,
        enterprise.address,
      ]);
    });
  });
});
